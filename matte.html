<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="matte.css">
    <title>StudyBuddy-Matte</title>
    <script src="https://js.puter.com/v2/"></script>
</head>
<body>
    <a href="home.html" class="back-link">Tilbaka</a>

    <div id="game-container">
        <div class="top-bar">
            <div class="stat"><span class="label">NIVÅ</span><span id="level-display">1</span></div>
            <div class="stat"><span class="label">STREAK</span><span id="streak-display">0</span></div>
        </div>
        
        <div class="progress-wrapper">
            <div id="progress-fill"></div>
        </div>

        <div class="question-box">
            <span id="ai-status">AI GENERERAR...</span>
            <h1 id="question-text"></h1>
        </div>
        
        <div class="input-wrapper">
            <input id="answer-input" placeholder="SVAR" autofocus >
            <button onclick="checkAnswer()">Guess</button>
            <div id="feedback"></div>
        </div>

        <div id="ai-explanation-box" class="hidden">
            <div class="ai-header">AI Analys</div>
            <p id="explanation-text"></p>
            <button class="primary-btn" onclick="GetNextQuestion()">Nästa fråga</button>
        </div>

        <button id="ask-ai-btn" class="secondary-btn hidden">Be ai förklara</button>
    </div>
    <script>
        const questionText = document.getElementById('question-text');
        const answerText = document.getElementById('answer-text');
        const explanationText = document.getElementById('explanation-text');
        const inputElement = document.getElementById('answer-input');
        const aiExplanationBox = document.getElementById('ai-explanation-box');
        const streakDisplay = document.getElementById("streak-display");

        let questions = [""];
        let questionIndex = -1;

        let currentQuestion = "";
        let currentAnswers = [];
        let currentExplanation = "";

        document.addEventListener("DOMContentLoaded", async () => {
                await GetNewQuestions("5", "matte", "1c");
        });

        async function GetNewQuestions(amount = "2", subject = "matte", level = "1c"){
            questionIndex = -1;
            const newQuestions = await getAIResponse(amount, subject, level);
            questions.length = 0;
            newQuestions.map((element) => {
                questions.push(element);
            })
            GetNextQuestion()
        }

        async function GetNextQuestion() {
            aiExplanationBox.setAttribute("class", "hidden");
            questionIndex++;

            let questionParts = questions[questionIndex].split(":::");
            
            currentQuestion = questionParts[0];
            currentAnswers = questionParts[1].split(",");
            currentExplanation = questionParts[2];

            questionText.innerText = currentQuestion;
        }

        function checkAnswer(){
            console.log(currentAnswers)
            console.log(inputElement.value)

            let answerNoSpaces = [];
            currentAnswers.map((element)=>
            {
                answerNoSpaces.push(element.replace(/\s/g, ''))
            });
            console.log(answerNoSpaces);
            if (answerNoSpaces.includes(inputElement.value.replace(/\s/g, '')))
            {
                console.log("correct");
                streakDisplay.innerText = (parseInt(streakDisplay.innerText) + 1).toString();
            }
            else{
                console.log("incorrect")
                streakDisplay.innerText = "0";
            }
            inputElement.value = "";
            aiExplanationBox.removeAttribute("class");
            //answerText.innerText = currentAnswers[0];
            explanationText.innerText = currentExplanation;
        }

        async function getAIResponse(amount = "1", subject = "matte", level = "1c") {
        let prompt = `
            Generate ${amount} ${subject}tasks at ${subject} ${level} level (Swedish high school).

            Rules:
            - Each task should be unique.
            - Adapted for ${subject} ${level}.
            - Return EVERYTHING as a single text without extra comments.
            - Use EXACT separators as below.

            Separators:
            - Between TASK / ANSWER / EXPLANATION: :::
            - Between DIFFERENT TASKS: |||

            FORMAT (EXACT):
            <task>:::<answer>:::<short explanation>|||<task>:::<answer>:::<short explanation>

            Units and prefixes:
            - If the answer contains unit or SI prefix, ALL correct spellings should be listed.
            - Separate multiple correct answers with commas (,).

            Important:
            - DO NOT use ::: or ||| anywhere other than as separators.
            - No markdown, no headings, no emojis.
            - Each explanation should be 1–3 sentences.
        `;

        try {
            const response = await puter.ai.chat(prompt);
            const AIresponse = response.message.content;
            
            return AIresponse.split("|||"); 
        } catch (error) {
            console.error("AI Fetch failed:", error);
            return [];
        }
    }
    </script>
</body>
</html>